<html>
<head>
  <title>06二级缓冲sessionfactory</title>
  <basefont face="Tahoma" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/272236; Windows/6.1.7601 Service Pack 1;"/>
  <style>
    body, td {
      font-family: Tahoma;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="5431"/>
<h1>06二级缓冲sessionfactory</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2014/8/7 22:52</i></td></tr>
<tr><td><b>更新时间：</b></td><td><i>2014/8/19 19:57</i></td></tr>
<tr><td><b>标签：</b></td><td><i>Hibernate, 二级缓存</i></td></tr>
</table>
</div>
<br/>

<div>
<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div align="justify"><font color="#010101" face="宋体">二级缓存由缓存提供者提供（</font> <font color="#010101" face="Times New Roman">Cache Provider</font><font color="#010101" face="宋体">），包含四部分：</font><font color="#FF0000" face="宋体">类缓存区、集合缓存区、查询缓存区、更新时间戳</font></div><div align="justify"><font color="#FF0000" face="宋体">也就是说，查询缓存，依赖于二级缓存。</font></div><div align="justify"><img src="06二级缓冲sessionfactory_files/Image.png" type="image/png" alt="graphic" border="0" height="305" style="cursor: default;cursor: default;cursor: default;cursor: default;" width="549"/></div><div><img src="06二级缓冲sessionfactory_files/Image [1].png" type="image/png" height="224" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="651"/></div><div><br/></div><div><br/></div><div>1、     是sessionFactory级别的缓存<br/>
2、     存放的是公有数据:共享数据，最后不修改。<br/>
3、     二级缓存的生命周期是随着hibernate容器启动就开了，hibernate销毁，结束。<br/>
4、     Hibernate本身对二级缓存没有提供实现，是借助第三方插件实现的。<br/></div><hr/><div><font color="#010101" face="宋体">二级缓存</font></div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 173%;"><font color="#010101" face="宋体">概念</font></p><div align="justify"><font color="#010101" face="Times New Roman">       1</font> <font color="#010101" face="宋体">、该缓存在</font> <font color="#010101" face="Times New Roman">sessionFactory</font><font color="#010101" face="宋体">中</font></div><div align="justify"><font color="#010101" face="Times New Roman">              </font> <img src="06二级缓冲sessionfactory_files/Image [2].png" type="image/png" alt="graphic" border="0" height="40" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="280"/></div><div align="justify"><font color="#010101" face="Times New Roman">      </font> <img src="06二级缓冲sessionfactory_files/Image [3].png" type="image/png" alt="graphic" border="0" height="20" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="551"/></div><div align="justify"><font color="#010101" face="Times New Roman">    2</font> <font color="#010101" face="宋体">、当</font><font color="#010101" face="Times New Roman">hibernate</font><font color="#010101" face="宋体">容器启动的时候，二级缓存就存在了，只有当</font> <font color="#010101" face="Times New Roman">hibernate</font><font color="#010101" face="宋体">容器关闭</font></div><div align="justify"><font color="#010101" face="Times New Roman">           </font> <font color="#010101" face="宋体">的时候，二级缓存才要销毁。</font></div><div align="justify"><font color="#010101" face="Times New Roman">    3</font> <font color="#010101" face="宋体">、二级缓存中的数据是<span style="background-color:rgb(255, 250, 165);-evernote-highlight:true;">公有数据</span>，任何人都能访问。</font></div><div align="justify"><font color="#010101" face="Times New Roman">    4</font> <font color="#010101" face="宋体">、类似火车的票务信息、飞机的票务信息都可以放入到二级缓存中</font></div><div align="justify"><font color="#010101" face="Times New Roman">    5</font> <font color="#010101" face="宋体">、二级缓存存放的数据应该是经常<span style="background-color:rgb(255, 250, 165);-evernote-highlight:true;">不修改的数据</span></font></div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 173%;"><font color="#010101" face="宋体">二级缓存的特点</font></p><div align="justify"><font color="#010101" face="Times New Roman">       </font> <font color="#010101" face="宋体">是借助第三方插件实现的二级缓存。</font></div><div align="justify"><font color="#010101" face="Times New Roman">   </font> <font color="#010101" face="宋体">在这里用</font> <font color="#010101" face="Times New Roman">ehcache</font><font color="#010101" face="宋体">实现。</font></div><div><br/></div><div><font color="#010101" face="宋体">配置步骤</font></div><div><font color="#010101" face="Times New Roman"><br/></font></div><div><font color="#010101" face="Times New Roman">   1</font> <font color="#010101" face="宋体">、在</font><font color="#010101" face="Times New Roman">hibernate</font><font color="#010101" face="宋体">的配置文件中指定二级缓存的供应商</font></div><div><br/></div><div align="justify"><font color="#010101" face="Times New Roman">              </font> <img src="06二级缓冲sessionfactory_files/Image [4].png" type="image/png" alt="graphic" border="0" height="50" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="547"/></div><div align="justify"><font color="#010101" face="Times New Roman">   2</font> <font color="#010101" face="宋体">、开启二级缓存</font></div><div align="justify"><font color="#010101" face="Times New Roman">       </font> <img src="06二级缓冲sessionfactory_files/Image [5].png" type="image/png" alt="graphic" border="0" height="67" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="547"/></div><div align="justify"><font color="#010101" face="Times New Roman">   3</font> <font color="#010101" face="宋体">、开启二级缓存的统计机制</font></div><div align="justify"><font color="#010101" face="Times New Roman">       </font> <img src="06二级缓冲sessionfactory_files/Image [6].png" type="image/png" alt="graphic" border="0" height="67" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="547"/></div><div align="justify"><font color="#010101" face="Times New Roman">   4</font> <font color="#010101" face="宋体">、针对某一个类开启二级缓存（二级缓存使用的是read-only，表明二级缓存是只读的。不能修改，这个也是二级缓存存在的目的，）</font></div><div align="justify"><font color="#010101" face="Times New Roman">              </font> <font color="#010101" face="宋体">在</font><font color="#010101" face="Times New Roman">Classes.hbm.xml</font><font color="#010101" face="宋体">文件中</font></div><div align="justify"><font color="#010101" face="Times New Roman">              </font> <img src="06二级缓冲sessionfactory_files/Image [7].png" type="image/png" alt="graphic" border="0" height="39" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="548"/><a href="06二级缓冲sessionfactory_files/hibernate.cfg.xml"><img src="06二级缓冲sessionfactory_files/7b2c481f2fac2ce250dff934ade79541.png" alt="hibernate.cfg.xml"></a></div><hr/><div align="left">session.get，</div><div>session.createQuery(hql).list()（前提是没有写select语句，或者是select new 一个对象，或者是where条件语句。这样，数据就会以对象封装到list中去。）</div><div><font color="#E30000">这两种方法，把数据放到二级缓存中去</font>。当二级缓存被开启的时候，就不能够在修改数据，因此，在调试的时候，一定要注意。</div><div>另外：list()该方法能把一个对象放入到二级缓存中，但是不利用二级缓存获取对象。也就是说，list每一次都是从数据库中获得，放入二级缓存中，不会从二级缓存中，获得。</div><div><br/></div><div>session.save方法不往二级缓存中存储数据</div><div>session.update方法不往二级缓存中存储数据</div><div>session.flush方法也不往二级缓存中存储数据</div><div><br/></div><div>二级缓存分为类的二级缓存和集合的二级缓存。</div><div><hr/></div><div><div><font color="#010101" face="黑体"><br/></font></div><div style="font-size: 64px;"><font color="#7600D8" face="黑体"><b style="background-color:rgb(255, 250, 165);-evernote-highlight:true;">类的二级缓存</b></font></div><div><font color="#010101" face="黑体">案例</font><font color="#010101" face="Arial">1</font></div><div><br/></div><div align="justify"><font color="#010101" face="Times New Roman">       </font> <img src="06二级缓冲sessionfactory_files/Image [8].png" type="image/png" alt="graphic" border="0" height="139" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="552"/></div><div align="justify"><font color="#010101" face="宋体">说明：</font></div><div align="justify"><font color="#010101" face="Times New Roman">     </font> <font color="#010101" face="宋体">当第二次执行</font> <font color="#010101" face="Times New Roman">session.get</font><font color="#010101" face="宋体">方法的时候，并没有发出</font> <font color="#010101" face="Times New Roman">sql</font><font color="#010101" face="宋体">语句，表明get方式，也会把数据放到二级缓存中去。</font></div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 173%;"><font color="#010101" face="黑体">案例</font><font color="#010101" face="Arial">2 </font></p><div align="justify"><font color="#010101" face="Times New Roman">       </font> <img src="06二级缓冲sessionfactory_files/Image [9].png" type="image/png" alt="graphic" border="0" height="129" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="545"/></div><div align="justify"><font color="#010101" face="宋体">说明：</font> <font color="#010101" face="Times New Roman">session.save</font><font color="#010101" face="宋体">方法不进二级缓存</font></div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 173%;"><font color="#010101" face="黑体">案例</font><font color="#010101" face="Arial">3</font></p><div align="justify"><font color="#010101" face="Times New Roman">       </font> <img src="06二级缓冲sessionfactory_files/Image [10].png" type="image/png" alt="graphic" border="0" height="143" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="547"/></div><div align="justify"><font color="#010101" face="宋体">说明：</font></div><div align="justify"><font color="#010101" face="Times New Roman">     Update</font> <font color="#010101" face="宋体">方法不能让一个对象进入到二级缓存中。</font></div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 173%;"><font color="#010101" face="黑体">案例</font><font color="#010101" face="Arial">4</font></p><div align="justify"><font color="#010101" face="Times New Roman">       </font> <img src="06二级缓冲sessionfactory_files/Image [11].png" type="image/png" alt="graphic" border="0" height="186" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="556"/></div><div align="justify"><font color="#010101" face="Times New Roman"><br/></font></div><div align="justify"><font color="#010101" face="宋体">说明：</font></div><div align="justify"><font color="#010101" face="Times New Roman">    </font> <font color="#010101" face="宋体">执行</font><font color="#010101" face="Times New Roman">55</font><font color="#010101" face="宋体">行代码的时候，把</font> <font color="#010101" face="Times New Roman">classes</font><font face="宋体"><font color="#010101">表中的所有的对象进入到了二级缓存中（</font><b style="font-size: 32px;"><font color="#7600D8" style="background-color: rgb(255, 250, 165);">原因是没有select语句，直接就是where条件查询。放到list中的，是一个一个的对象，而不是对象中的属性，明白？？？</font></b><font color="#010101">）</font></font></div><div align="justify"><font color="#010101" face="Times New Roman">       </font> <font color="#010101" face="宋体">执行</font><font color="#010101" face="Times New Roman">59</font><font color="#010101" face="宋体">行代码的时候，重新从数据库中查找记录</font></div><div align="justify"><font color="#010101" face="Times New Roman">    </font> <font color="#010101" face="宋体">所以</font><font color="#010101" face="Times New Roman">createQuery(hql).list</font><b style="background-color:rgb(255, 250, 165);-evernote-highlight:true;"><font color="#010101" face="宋体">方法能把一个对象放入到二级缓存中，但是不利用二级缓存获取对象。</font><span style="color: rgb(1, 1, 1);">也就是说，list每一次都是从数据库中获得数据，放入二级缓存中，不会从二级缓存中，获得数据。</span></b></div><div><br/></div><div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 172%;"><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt"><b>get</b></span></font><font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>和</b></span></font><font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt"><b>load</b></span></font> <font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>可以读取类级别二级缓存，</b></span></font> <font color="#010101" face="Times New Roman" size="4"><span style="font-size:16pt"><b>Query.list</b></span></font> <font color="#010101" face="宋体" size="4"><span style="font-size:16pt"><b>只能存，不能取</b></span></font></p></div><div><font color="#010101" face="黑体"><br/></font></div><div><font color="#010101" face="黑体"><br/></font></div><div><font color="#010101" face="黑体">案例</font><font color="#010101" face="Arial">5</font></div><div><br/></div><div align="justify"><font color="#010101" face="Times New Roman">       </font> <font color="#010101" face="宋体">在</font><font color="#010101" face="Times New Roman">classpath</font><font color="#010101" face="宋体">的根目录下放置一个</font> <font color="#010101" face="Times New Roman">ehcache.xml</font><font color="#010101" face="宋体">文件</font></div><div align="justify"><font color="#010101" face="Times New Roman">       </font> <img src="06二级缓冲sessionfactory_files/Image [12].png" type="image/png" alt="graphic" border="0" height="231" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="553"/></div><div align="justify"><img src="06二级缓冲sessionfactory_files/Image [13].png" type="image/png" alt="graphic" border="0" height="24" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="338"/></div><div align="justify"><font color="#010101" face="宋体">从上述的配置可以看出，</font> <font color="#010101" face="Times New Roman">classes</font><font color="#010101" face="宋体">对象在内存中存放的数量最多为</font> <font color="#010101" face="Times New Roman">5</font><font color="#010101" face="宋体">个，多余的对象将存在磁盘上。</font></div><div align="justify"><img src="06二级缓冲sessionfactory_files/Image [14].png" type="image/png" alt="graphic" border="0" height="119" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="550"/></div><div align="justify"><font color="#010101" face="宋体">查找</font> <font color="#010101" face="Times New Roman">classes</font><font color="#010101" face="宋体">表中所有的对象，在内存中放置</font> <font color="#010101" face="Times New Roman">5</font><font color="#010101" face="宋体">个对象，剩余的对象将被存在磁盘上。</font></div><div align="justify"><hr/></div><div><br/></div><div><b style="background-color:rgb(255, 250, 165);-evernote-highlight:true;color: rgb(118, 0, 216); font-family: 黑体; font-size: 64px;">集合的二级缓存</b></div><div><font color="#010101" face="黑体">案例</font><font color="#010101" face="Arial">6</font></div><div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 173%;"><font color="#010101" face="宋体" size="4"><span style="font-size:16pt">二级缓存的集合缓存</span></font></p><div align="justify"><font color="#010101" face="Times New Roman" size="2"><span style="font-size:10pt">       </span></font> <img src="06二级缓冲sessionfactory_files/Image [15].png" type="image/png" alt="graphic" border="0" height="31" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="171"/></div><div align="justify"><img src="06二级缓冲sessionfactory_files/Image [16].png" type="image/png" alt="graphic" border="0" height="34" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="553"/></div><div align="justify"> </div></div><div align="justify"><font color="#010101" face="Times New Roman"> </font><font color="#010101" face="宋体" style="font-size: 48px;">相当于开启了</font><font color="#010101" face="Times New Roman" style="font-size: 48px;">classes</font><font color="#010101" face="宋体" style="font-size: 48px;">类中的</font> <font color="#010101" face="Times New Roman" style="font-size: 48px;">set</font><font color="#010101" face="宋体" style="font-size: 48px;">集合的二级缓存</font></div><div align="justify"><img src="06二级缓冲sessionfactory_files/Image [17].png" type="image/png" alt="graphic" border="0" height="125" style="cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;cursor: default;" width="553"/></div><div align="justify"><font color="#010101" face="宋体">把集合放入到了二级缓存中。</font></div><div align="justify"><hr/></div><p align="justify" style="margin-left:0mm; margin-right:0mm; text-indent:0mm; margin-top:4.57mm; margin-bottom:4.57mm;line-height: 173%;"><font color="#010101" face="黑体">读写策略</font></p><div align="justify"><font color="#010101" face="Times New Roman">       Usage</font></div><div align="justify"><font color="#010101" face="Times New Roman">              Ready-only</font></div><div align="justify"><font color="#010101" face="Times New Roman">                     </font> <font color="#010101" face="宋体">只能把一个对象放入到二级缓存中不能修改</font></div><div align="justify"><font color="#010101" face="Times New Roman">       Read-write</font></div><div align="justify"><font color="#010101" face="Times New Roman">           </font> <font color="#010101" face="宋体">能把一个对象放入到二级缓存中，也能修改</font></div></div><div align="justify"><font color="#010101" face="宋体"><br/></font></div><div align="justify"><hr/><div align="left" style="text-align: -webkit-auto;">sessionFactory.getStatistics().getCollectionLoadCount()；二级缓存中集合的个数</div></div><div>sessionFactory.getStatistics().getEntityLoadCount()；二级缓存中对象的个数</div><div><br/></div><div>session.getStatistics().getCollectionCount();一级缓存中，集合的个数。</div><div>session.getStatistics().getEntityCount();   一级缓存中，对象的个数。</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div>
</div></body></html> 